<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XMCE-MaiMai比赛歌曲选择器</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        :root {
            --primary: #00b2ff;
            --secondary: #404040;
            --accent: #0090f7;
            --light: #f0f8ff;
            --dark: #1a1a2e;
            --card-bg: rgba(255, 255, 255, 0.85);
        }

        body {
            background: linear-gradient(135deg, var(--dark), #16213e);
            color: white;
            min-height: 100vh;
            overflow: hidden;
            position: relative;
        }

        .bubbles {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            filter: blur(5px);
        }

        .bubble {
            position: absolute;
            border-radius: 50%;
            background: rgba(0, 178, 255, 0.2);
            box-shadow: 0 0 20px rgba(0, 178, 255, 0.5);
            animation: float 15s infinite ease-in-out;
        }

        @keyframes float {
            0%, 100% {
                transform: translateY(0) translateX(0);
            }
            25% {
                transform: translateY(-20px) translateX(10px);
            }
            50% {
                transform: translateY(-40px) translateX(20px);
            }
            75% {
                transform: translateY(-20px) translateX(-10px);
            }
        }

        .container {
            display: flex;
            min-height: 100vh;
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        /* 左侧导航栏 */
        .sidebar {
            width: 220px;
            background: rgba(64, 64, 64, 0.7);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px 15px;
            margin-right: 20px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .logo {
            text-align: center;
            margin-bottom: 40px;
        }

        .logo img {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 50%;
            border: 3px solid var(--primary);
        }

        .logo h1 {
            font-size: 1.8rem;
            margin-top: 10px;
            color: var(--primary);
            font-weight: 700;
            letter-spacing: 1px;
        }

        .nav-btn {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            margin: 10px 0;
            border-radius: 12px;
            background: transparent;
            color: white;
            font-size: 1.1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            text-align: left;
        }

        .nav-btn i {
            margin-right: 15px;
            font-size: 1.3rem;
        }

        .nav-btn:hover {
            background: rgba(0, 178, 255, 0.2);
        }

        .nav-btn.active {
            background: var(--primary);
            box-shadow: 0 0 15px rgba(0, 178, 255, 0.7);
        }

        /* 主内容区 */
        .main-content {
            flex: 1;
            background: rgba(64, 64, 64, 0.7);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            position: relative;
        }

        .page {
            display: none;
            height: 100%;
            animation: fadeIn 0.5s ease;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* 抽选页面 */
        .draw-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            padding: 20px;
        }

        .result-display {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 40px;
            width: 100%;
        }

        .cover-container {
            width: 300px;
            height: 300px;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            margin-bottom: 25px;
            position: relative;
            background: var(--dark);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .cover-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }

        .cover-image:hover {
            transform: scale(1.05);
        }

        .song-info {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 25px;
            width: 100%;
            max-width: 600px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
            color: var(--secondary);
            text-align: center;
        }

        .song-title {
            font-size: 2.2rem;
            font-weight: 700;
            margin-bottom: 15px;
            color: var(--primary);
        }

        .song-artist {
            font-size: 1.4rem;
            margin-bottom: 20px;
            color: #555;
        }

        .song-details {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 20px;
        }

        .detail-item {
            background: rgba(0, 178, 255, 0.1);
            padding: 12px 20px;
            border-radius: 12px;
            min-width: 120px;
        }

        .detail-label {
            font-size: 0.9rem;
            color: #777;
            margin-bottom: 5px;
        }

        .detail-value {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--dark);
        }

        .levels {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .level {
            background: linear-gradient(to bottom, #6a11cb 0%, #2575fc 100%);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: 700;
            min-width: 60px;
            text-align: center;
            font-size: 0.9rem;
        }

        .additional-info {
            background: rgba(0, 178, 255, 0.1);
            padding: 15px;
            border-radius: 12px;
            margin-top: 20px;
            width: 100%;
            text-align: left;
        }

        .info-row {
            display: flex;
            margin-bottom: 8px;
        }

        .info-label {
            font-weight: 600;
            min-width: 80px;
            color: #00b2ff;
        }

        .info-value {
            flex: 1;
            color: var(--dark);
        }

        .draw-button {
            background: var(--primary);
            color: white;
            font-size: 1.4rem;
            font-weight: 700;
            padding: 18px 50px;
            border-radius: 50px;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(0, 178, 255, 0.5);
            position: relative;
            overflow: hidden;
            margin-top: 20px;
        }

        .draw-button:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 30px rgba(0, 178, 255, 0.7);
        }

        .draw-button:active {
            transform: scale(0.95);
        }

        .draw-button.jelly {
            animation: jelly 0.5s ease;
        }

        @keyframes jelly {
            0%, 100% { transform: scale(1, 1); }
            25% { transform: scale(0.95, 1.05); }
            50% { transform: scale(1.05, 0.95); }
            75% { transform: scale(0.95, 1.05); }
        }

        .countdown {
            font-size: 8rem;
            font-weight: 900;
            color: var(--accent);
            text-shadow: 0 0 20px rgba(255, 255, 255, 0.7);
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 10;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.1); }
        }

        /* 设置页面 */
        .settings-container {
            padding: 20px;
        }

        .settings-title {
            font-size: 2rem;
            margin-bottom: 30px;
            color: var(--primary);
            text-align: center;
        }

        .settings-section {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            color: var(--secondary);
        }

        .section-title {
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: var(--primary);
            display: flex;
            align-items: center;
        }

        .section-title i {
            margin-right: 10px;
        }

        .file-upload {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            gap: 15px;
            flex-wrap: wrap;
        }

        .file-label {
            background: var(--primary);
            color: white;
            padding: 12px 25px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-block;
            font-weight: 500;
        }

        .file-label:hover {
            background: #0099e0;
        }

        .file-name {
            font-style: italic;
        }

        .load-btn {
            background: #0073ff;
            color: white;
            padding: 12px 25px;
            border-radius: 12px;
            border: none;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .load-btn:hover {
            background: #00ccff;
        }

        .filter-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin: 20px 0;
        }

        .filter-group {
            flex: 1;
            min-width: 200px;
        }

        .filter-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }

        select, input {
            width: 100%;
            padding: 12px 15px;
            border-radius: 12px;
            border: 2px solid #ddd;
            background: white;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        select:focus, input:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(0, 178, 255, 0.2);
        }

        .stats {
            margin-top: 15px;
            font-size: 1.1rem;
        }

        .stats span {
            font-weight: 700;
            color: var(--primary);
        }

        .footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .copyright {
            color: rgba(255, 255, 255, 0.7);
        }

        .github-btn {
            background: #333;
            color: white;
            padding: 10px 25px;
            border-radius: 50px;
            text-decoration: none;
            display: flex;
            align-items: center;
            transition: all 0.3s ease;
        }

        .github-btn:hover {
            background: #444;
            transform: translateY(-3px);
        }

        .github-btn i {
            margin-right: 10px;
        }

        /* 制作页面 */
        .creator-container {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .search-container {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }

        .search-box {
            display: flex;
            gap: 15px;
        }

        .search-input {
            flex: 1;
            padding: 14px 20px;
            border-radius: 12px;
            border: 2px solid #ddd;
            font-size: 1.1rem;
        }

        .search-btn {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 0 30px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .search-btn:hover {
            background: #0099e0;
        }

        .results-container {
            display: flex;
            flex: 1;
            gap: 20px;
            min-height: 0;
        }

        .search-results {
            flex: 1;
            background: var(--card-bg);
            border-radius: 16px;
            padding: 20px;
            overflow-y: auto;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }

        .selected-songs {
            width: 350px;
            background: var(--card-bg);
            border-radius: 16px;
            padding: 20px;
            overflow-y: auto;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }

        .panel-title {
            font-size: 1.4rem;
            margin-bottom: 20px;
            color: var(--primary);
            display: flex;
            align-items: center;
        }

        .panel-title i {
            margin-right: 10px;
        }

        .song-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }

        .song-item {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            cursor: pointer;
            display: flex;
            flex-direction: column;
        }

        .song-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.15);
        }

        .song-thumb {
            height: 120px;
            width: 100%;
            object-fit: cover;
        }

        .song-meta {
            padding: 15px;
        }

        .song-name {
            font-weight: 700;
            margin-bottom: 5px;
            color: var(--dark);
            font-size: 1.1rem;
        }

        .song-artist-small {
            color: #777;
            font-size: 0.9rem;
        }

        .selected-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .selected-item {
            display: flex;
            align-items: center;
            background: white;
            border-radius: 12px;
            padding: 12px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }

        .selected-thumb {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            object-fit: cover;
            margin-right: 15px;
        }

        .selected-info {
            flex: 1;
        }

        .remove-btn {
            background: #ff6b6b;
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .remove-btn:hover {
            background: #ff5252;
            transform: rotate(90deg);
        }

        .save-btn {
            align-self: flex-end;
            background: var(--accent);
            color: white;
            border: none;
            padding: 12px 35px;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
        }

        .save-btn:hover {
            background: #00aeff;
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 81, 255, 0.4);
        }

        .save-btn i {
            margin-right: 10px;
        }

        /* 全屏模式 */
        body.fullscreen {
            overflow: auto;
            padding: 20px;
        }

        body.fullscreen .container {
            max-width: 100%;
            height: auto;
        }

        body.fullscreen .cover-container {
            width: 500px;
            height: 500px;
        }

        /* 响应式设计 */
        @media (max-width: 1200px) {
            .container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                margin-right: 0;
                margin-bottom: 20px;
                flex-direction: row;
                justify-content: space-around;
                padding: 15px;
            }
            
            .logo {
                display: none;
            }
            
            .nav-btn {
                margin: 0 5px;
                padding: 12px 15px;
                font-size: 0.9rem;
            }
            
            .nav-btn span {
                display: none;
            }
            
            .nav-btn i {
                margin-right: 0;
            }
            
            .song-details {
                flex-direction: column;
                align-items: center;
                gap: 10px;
            }
            
            .results-container {
                flex-direction: column;
            }
            
            .selected-songs {
                width: 100%;
                max-height: 300px;
            }
        }

        @media (max-width: 768px) {
            .cover-container {
                width: 250px;
                height: 250px;
            }
            
            body.fullscreen .cover-container {
                width: 350px;
                height: 350px;
            }
            
            .song-title {
                font-size: 1.8rem;
            }
            
            .song-artist {
                font-size: 1.2rem;
            }
        }
        
        /* 模态框 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            color: var(--secondary);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            position: relative;
        }
        
        .close-modal {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 1.5rem;
            cursor: pointer;
            color: #777;
            transition: all 0.3s ease;
        }
        
        .close-modal:hover {
            color: var(--primary);
            transform: rotate(90deg);
        }
        
        .modal-title {
            font-size: 1.8rem;
            color: var(--primary);
            margin-bottom: 20px;
            text-align: center;
        }
        
        .modal-message {
            font-size: 1.2rem;
            line-height: 1.6;
            margin-bottom: 30px;
        }
        
        .modal-highlight {
            color: var(--accent);
            font-weight: 700;
            font-size: 1.3rem;
        }
        
        .modal-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 50px;
            font-size: 1.1rem;
            cursor: pointer;
            margin: 10px auto;
            display: block;
            transition: all 0.3s ease;
        }
        
        .modal-btn:hover {
            background: #0099e0;
            transform: translateY(-3px);
        }
        
        /* 初始状态样式 */
        .initial-state .song-title {
            color: #999;
        }
        
        .initial-state .cover-image {
            opacity: 0.2;
        }
        
        .initial-state .levels {
            display: none;
        }
        
        /* 难度标签 */
        .level-tag {
            background: rgba(0, 178, 255, 0.15);
            color: #00b2ff;
            padding: 3px 8px;
            border-radius: 6px;
            font-size: 0.8rem;
            margin-right: 5px;
            margin-bottom: 5px;
            display: inline-block;
        }
        
        .selected-levels {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 15px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
        }
        
        .selected-level {
            background: var(--primary);
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
        }
        
        .remove-level {
            margin-left: 8px;
            cursor: pointer;
            font-size: 1.1rem;
        }
    </style>
</head>
<body>
    <!-- 气泡背景 -->
    <div class="bubbles" id="bubbles"></div>
    
    <!-- 模态框 -->
    <div class="modal" id="info-modal">
        <div class="modal-content">
            <span class="close-modal" id="close-modal">&times;</span>
            <h2 class="modal-title">数据库加载成功</h2>
            <p class="modal-message">已成功加载 <span class="modal-highlight" id="loaded-count">0</span> 首歌曲</p>
            <p class="modal-message">当前筛选后可用歌曲: <span class="modal-highlight" id="filtered-count-modal">0</span> 首</p>
            <div class="selected-levels" id="selected-levels-display">
                <!-- 已选难度将在这里显示 -->
            </div>
            <button class="modal-btn" id="modal-ok-btn">确定</button>
        </div>
    </div>
    
    <div class="container">
        <!-- 左侧导航栏 -->
        <div class="sidebar">
            <div class="logo">
                <img src="http://q2.qlogo.cn/headimg_dl?dst_uin=3616193292&spec=100" alt="XMaoLogo">
                <h1>Mai-XMCE</h1>
            </div>
            <button class="nav-btn active" data-page="draw">
                <i class="fas fa-random"></i>
                <span>歌曲抽选</span>
            </button>
            <button class="nav-btn" data-page="settings">
                <i class="fas fa-cog"></i>
                <span>系统设置</span>
            </button>
            <button class="nav-btn" data-page="creator">
                <i class="fas fa-music"></i>
                <span>歌单制作</span>
            </button>
        </div>
        
        <!-- 主内容区 -->
        <div class="main-content">
            <!-- 抽选页面 -->
            <div class="page active" id="draw-page">
                <div class="draw-container">
                    <div class="result-display initial-state">
                        <div class="cover-container">
                            <img id="cover-image" src="http://q2.qlogo.cn/headimg_dl?dst_uin=2678050041&spec=100" alt="Song Cover" class="cover-image">
                            <div class="countdown" id="countdown" style="display: none;">5</div>
                        </div>
                        <div class="song-info">
                            <h2 class="song-title" id="song-title">等待抽选...</h2>
                            <p class="song-artist" id="song-artist">选择一首随机歌曲开始比赛</p>
                            
                            <div class="song-details">
                                <div class="detail-item">
                                    <div class="detail-label">BPM</div>
                                    <div class="detail-value" id="song-bpm">-</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label">版本</div>
                                    <div class="detail-value" id="song-version">-</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label">定数</div>
                                    <div class="detail-value" id="song-diff">-</div>
                                </div>
                            </div>
                            
                            <div class="levels">
                                <div class="level">Basic: -</div>
                                <div class="level">Advanced: -</div>
                                <div class="level">Expert: -</div>
                                <div class="level">Master: -</div>
                            </div>
                            
                            <div class="additional-info">
                                <div class="info-row">
                                    <span class="info-label">MusicID:</span>
                                    <span class="info-value" id="song-id">-</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">类型:</span>
                                    <span class="info-value" id="song-type">-</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">别名:</span>
                                    <span class="info-value" id="song-alias">-</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <button class="draw-button" id="draw-button">
                        <i class="fas fa-dice"></i> 开始抽选
                    </button>
                </div>
            </div>
            
            <!-- 设置页面 -->
            <div class="page" id="settings-page">
                <div class="settings-container">
                    <h2 class="settings-title"><i class="fas fa-cog"></i> 系统设置</h2>
                    
                    <div class="settings-section">
                        <h3 class="section-title"><i class="fas fa-database"></i> 数据库管理</h3>
                        
                        <div class="file-upload">
                            <label class="file-label">
                                <i class="fas fa-file-import"></i> 选择JSON文件
                                <input type="file" id="json-upload" accept=".json" style="display: none;">
                            </label>
                            <span class="file-name" id="json-filename">未选择文件</span>
                            <button class="load-btn" id="load-btn">
                                <i class="fas fa-database"></i> 加载数据库
                            </button>
                        </div>
                        
                        <div class="filter-container">
                            <div class="filter-group">
                                <label class="filter-label">随机模式</label>
                                <select id="random-mode">
                                    <option value="all">全曲随机</option>
                                    <option value="partial">歌单筛选</option>
                                </select>
                            </div>
                            
                            <div class="filter-group">
                                <label class="filter-label">难度筛选</label>
                                <select id="level-filter" multiple>
                                    <option value="all">全部难度</option>
                                    <option value="1">1</option>
                                    <option value="2">2</option>
                                    <option value="3">3</option>
                                    <option value="4">4</option>
                                    <option value="5">5</option>
                                    <option value="6">6</option>
                                    <option value="7">7</option>
                                    <option value="7+">7+</option>
                                    <option value="8">8</option>
                                    <option value="8+">8+</option>
                                    <option value="9">9</option>
                                    <option value="9+">9+</option>
                                    <option value="10">10</option>
                                    <option value="10+">10+</option>
                                    <option value="11">11</option>
                                    <option value="11+">11+</option>
                                    <option value="12">12</option>
                                    <option value="12+">12+</option>
                                    <option value="13">13</option>
                                    <option value="13+">13+</option>
                                    <option value="14">14</option>
                                    <option value="14+">14+</option>
                                    <option value="15">15</option>
                                </select>
                                <p class="filter-label" style="margin-top: 8px; font-size: 0.9rem; color: #666;">
                                    按住Ctrl | 多选
                                </p>
                            </div>
                        </div>
                        
                        <div class="file-upload">
                            <label class="file-label" id="txt-upload-label" style="display: none;">
                                <i class="fas fa-file-alt"></i> 选择歌单文件
                                <input type="file" id="txt-upload" accept=".txt" style="display: none;">
                            </label>
                            <span class="file-name" id="txt-filename">未选择文件</span>
                        </div>
                        
                        <div class="stats">
                            共 <span id="song-count">0</span> 首歌曲 | 
                            依照条件过滤后 <span id="filtered-count">0</span> 首
                        </div>
                    </div>
                    
                    <div class="footer">
                        <div class="copyright">
                            &copy; 2025 XMaoCAT-MaiMaiExtraction | DataSources: Diving-Fish| MaiMaiJP
                        </div>
                        <a href="https://github.com/XMaoCAT" target="_blank" class="github-btn">
                            <i class="fab fa-github"></i> XMao GitHub
                        </a>
                    </div>
                </div>
            </div>
            
            <!-- 制作页面 -->
            <div class="page" id="creator-page">
                <div class="creator-container">
                    <div class="search-container">
                        <div class="search-box">
                            <input type="text" class="search-input" id="search-input" placeholder="搜索歌曲名称、别名或MusicID...">
                            <button class="search-btn" id="search-btn">
                                <i class="fas fa-search"></i> 搜索
                            </button>
                        </div>
                    </div>
                    
                    <div class="results-container">
                        <div class="search-results">
                            <h3 class="panel-title"><i class="fas fa-search"></i> 搜索结果</h3>
                            <div class="song-list" id="search-results">
                                <!-- 搜索结果将通过JS动态填充 -->
                            </div>
                        </div>
                        
                        <div class="selected-songs">
                            <h3 class="panel-title"><i class="fas fa-list"></i> 已选歌曲 <span id="selected-count">(0)</span></h3>
                            <div class="selected-list" id="selected-songs">
                                <!-- 已选歌曲将通过JS动态填充 -->
                            </div>
                            <button class="save-btn" id="save-btn">
                                <i class="fas fa-save"></i> 保存歌单
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 创建气泡背景
        function createBubbles() {
            const bubbleContainer = document.getElementById('bubbles');
            for (let i = 0; i < 50; i++) {
                const bubble = document.createElement('div');
                bubble.classList.add('bubble');
                
                // 随机大小 (10px - 80px)
                const size = Math.random() * 70 + 10;
                bubble.style.width = `${size}px`;
                bubble.style.height = `${size}px`;
                
                // 随机位置
                bubble.style.left = `${Math.random() * 100}%`;
                bubble.style.top = `${Math.random() * 100}%`;
                
                // 随机动画延迟和持续时间
                bubble.style.animationDelay = `${Math.random() * 15}s`;
                bubble.style.animationDuration = `${Math.random() * 10 + 10}s`;
                
                bubbleContainer.appendChild(bubble);
            }
        }

        // 页面导航
        function setupNavigation() {
            const navButtons = document.querySelectorAll('.nav-btn');
            const pages = document.querySelectorAll('.page');
            
            navButtons.forEach(button => {
                button.addEventListener('click', () => {
                    // 更新按钮状态
                    navButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    
                    // 显示对应页面
                    const pageId = button.dataset.page + '-page';
                    pages.forEach(page => {
                        page.classList.remove('active');
                        if (page.id === pageId) {
                            setTimeout(() => page.classList.add('active'), 10);
                        }
                    });
                });
            });
        }

        // 全局歌曲数据库
        let songDatabase = [];
        let filteredSongs = [];
        let playlistSongIds = [];
        let selectedLevels = new Set(['all']); // 默认选择全部难度
        
        // 获取封面URL
        function getCoverUrl(song) {
            const info = song.基础信息;
            if (info.type === "标准") {
                return `https://maimaidx.jp/maimai-mobile/img/Music/${info.image_url}`;
            } else {
                return `https://www.diving-fish.com/covers/${info.MusicID}.png`;
            }
        }
        
        // 更新已选难度显示
        function updateSelectedLevelsDisplay() {
            const container = document.getElementById('selected-levels-display');
            container.innerHTML = '';
            
            if (selectedLevels.size === 0 || selectedLevels.has('all')) {
                const level = document.createElement('div');
                level.classList.add('selected-level');
                level.textContent = '全部难度';
                container.appendChild(level);
                return;
            }
            
            selectedLevels.forEach(level => {
                if (level !== 'all') {
                    const levelElement = document.createElement('div');
                    levelElement.classList.add('selected-level');
                    levelElement.innerHTML = `
                        ${level}
                        <span class="remove-level" data-level="${level}">×</span>
                    `;
                    container.appendChild(levelElement);
                }
            });
            
            // 添加移除事件
            document.querySelectorAll('.remove-level').forEach(btn => {
                btn.addEventListener('click', function() {
                    const level = this.dataset.level;
                    selectedLevels.delete(level);
                    if (selectedLevels.size === 0) {
                        selectedLevels.add('all');
                    }
                    updateSelectedLevelsDisplay();
                    updateFilteredSongs();
                });
            });
        }
        
        // 根据难度筛选歌曲
        function updateFilteredSongs() {
            // 首先根据随机模式筛选
            let tempFiltered = [...songDatabase];
            
            // 如果选择了歌单模式并且有歌单ID
            const randomMode = document.getElementById('random-mode').value;
            if (randomMode === 'partial' && playlistSongIds.length > 0) {
                tempFiltered = tempFiltered.filter(song => 
                    playlistSongIds.includes(song.基础信息.MusicID.toString())
                );
            }
            
            // 然后根据难度筛选
            if (!selectedLevels.has('all')) {
                tempFiltered = tempFiltered.filter(song => {
                    const levels = song.基础信息.等级;
                    return levels.some(level => selectedLevels.has(level));
                });
            }
            
            filteredSongs = tempFiltered;
            document.getElementById('filtered-count').textContent = filteredSongs.length;
            document.getElementById('filtered-count-modal').textContent = filteredSongs.length;
        }
        
        // 显示模态框
        function showModal() {
            document.getElementById('info-modal').style.display = 'flex';
        }
        
        // 隐藏模态框
        function hideModal() {
            document.getElementById('info-modal').style.display = 'none';
        }

        // 初始化应用
        function initApp() {
            createBubbles();
            setupNavigation();
            updateSelectedLevelsDisplay();
            
            // 设置模态框事件
            document.getElementById('close-modal').addEventListener('click', hideModal);
            document.getElementById('modal-ok-btn').addEventListener('click', hideModal);
            
            // 设置抽选按钮事件
            const drawButton = document.getElementById('draw-button');
            drawButton.addEventListener('click', startDrawAnimation);
            
            // 设置文件上传事件
            const jsonUpload = document.getElementById('json-upload');
            const txtUpload = document.getElementById('txt-upload');
            const loadBtn = document.getElementById('load-btn');
            
            // 文件选择事件
            jsonUpload.addEventListener('change', function() {
                document.getElementById('json-filename').textContent = this.files[0]?.name || '未选择文件';
            });
            
            // 歌单文件上传事件
            txtUpload.addEventListener('change', function() {
                const file = this.files[0];
                if (!file) {
                    document.getElementById('txt-filename').textContent = '未选择文件';
                    return;
                }
                
                document.getElementById('txt-filename').textContent = file.name;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const content = e.target.result;
                        // 解析歌单文件内容（支持逗号分隔或换行分隔）
                        playlistSongIds = content.split(/[,\n]/)
                            .map(id => id.trim())
                            .filter(id => id !== '');
                        
                        // 更新过滤后的歌曲
                        updateFilteredSongs();
                        
                        // 显示成功消息
                        alert(`成功加载歌单，包含 ${playlistSongIds.length} 首歌曲`);
                    } catch (error) {
                        alert('解析歌单文件时出错: ' + error.message);
                    }
                };
                reader.readAsText(file);
            });
            
            // 加载按钮事件
            loadBtn.addEventListener('click', function() {
                const file = jsonUpload.files[0];
                if (!file) {
                    alert('请先选择JSON文件');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        // 解析JSON数据
                        songDatabase = JSON.parse(e.target.result);
                        filteredSongs = [...songDatabase];
                        
                        // 显示加载信息
                        document.getElementById('loaded-count').textContent = songDatabase.length;
                        document.getElementById('filtered-count-modal').textContent = songDatabase.length;
                        document.getElementById('song-count').textContent = songDatabase.length;
                        document.getElementById('filtered-count').textContent = songDatabase.length;
                        
                        // 显示模态框
                        showModal();
                        
                        // 更新制作页面
                        populateSearchResults(songDatabase);
                        
                        // 启用抽选按钮
                        drawButton.disabled = false;
                        drawButton.textContent = '开始抽选';
                        
                        // 更新状态
                        document.getElementById('draw-page').querySelector('.result-display').classList.remove('initial-state');
                    } catch (error) {
                        alert('解析JSON文件时出错: ' + error.message);
                    }
                };
                reader.readAsText(file);
            });
            
            // 设置随机模式切换
            const randomMode = document.getElementById('random-mode');
            randomMode.addEventListener('change', function() {
                const txtLabel = document.getElementById('txt-upload-label');
                if (this.value === 'partial') {
                    txtLabel.style.display = 'inline-block';
                } else {
                    txtLabel.style.display = 'none';
                    playlistSongIds = [];
                    document.getElementById('txt-filename').textContent = '未选择文件';
                    updateFilteredSongs();
                }
            });
            
            // 设置难度筛选
            const levelFilter = document.getElementById('level-filter');
            levelFilter.addEventListener('change', function() {
                selectedLevels.clear();
                
                const options = Array.from(this.selectedOptions);
                const hasAll = options.some(opt => opt.value === 'all');
                
                if (hasAll || options.length === 0) {
                    selectedLevels.add('all');
                } else {
                    options.forEach(opt => selectedLevels.add(opt.value));
                }
                
                updateSelectedLevelsDisplay();
                updateFilteredSongs();
            });
            
            // 初始化制作页面
            populateSearchResults(songDatabase);
            
            // 设置搜索功能
            const searchBtn = document.getElementById('search-btn');
            const searchInput = document.getElementById('search-input');
            
            searchBtn.addEventListener('click', () => searchSongs(searchInput.value));
            searchInput.addEventListener('input', () => searchSongs(searchInput.value));
            
            // 设置保存按钮
            document.getElementById('save-btn').addEventListener('click', savePlaylist);
            
            // 初始禁用抽选按钮
            drawButton.disabled = true;
            drawButton.textContent = '请先加载数据库';
        }

        // 开始抽选动画
        function startDrawAnimation() {
            if (songDatabase.length === 0) {
                alert('数据库为空，请先加载歌曲数据');
                return;
            }
            
            if (filteredSongs.length === 0) {
                alert('没有符合条件的歌曲，请调整筛选条件');
                return;
            }
            
            const drawButton = document.getElementById('draw-button');
            const countdown = document.getElementById('countdown');
            const coverImage = document.getElementById('cover-image');
            
            // 添加果冻动画效果
            drawButton.classList.add('jelly');
            setTimeout(() => drawButton.classList.remove('jelly'), 500);
            
            // 禁用按钮
            drawButton.disabled = true;
            
            // 显示倒计时
            countdown.style.display = 'block';
            
            // 倒计时从5到1
            let count = 5;
            countdown.textContent = count;
            
            const countdownInterval = setInterval(() => {
                count--;
                countdown.textContent = count;
                
                if (count <= 0) {
                    clearInterval(countdownInterval);
                    countdown.style.display = 'none';
                    
                    // 开始快速切换歌曲
                    startFastSwitching();
                }
            }, 1000);
        }

        // 快速切换歌曲效果（由快到慢）
        function startFastSwitching() {
            const coverImage = document.getElementById('cover-image');
            const songTitle = document.getElementById('song-title');
            const songArtist = document.getElementById('song-artist');
            const songBpm = document.getElementById('song-bpm');
            const songVersion = document.getElementById('song-version');
            const songDiff = document.getElementById('song-diff');
            const songId = document.getElementById('song-id');
            const songType = document.getElementById('song-type');
            const songAlias = document.getElementById('song-alias');
            const drawButton = document.getElementById('draw-button');
            
            let counter = 0;
            let speed = 50; // 初始速度（毫秒）
            let acceleration = 0; // 加速度
            const maxSwitches = 50; // 最大切换次数
            
            // 随机起始位置
            let startIndex = Math.floor(Math.random() * filteredSongs.length);
            
            const switchSong = () => {
                // 循环选择歌曲
                const currentIndex = (startIndex + counter) % filteredSongs.length;
                const song = filteredSongs[currentIndex];
                const info = song.基础信息;
                
                // 更新封面
                coverImage.src = getCoverUrl(song);
                
                // 更新信息
                songTitle.textContent = info.title;
                songArtist.textContent = info.artist;
                songBpm.textContent = info.bpm;
                songVersion.textContent = info.版本;
                songDiff.textContent = info.定数[3]; // 最高难度定数
                songId.textContent = info.MusicID;
                songType.textContent = info.type;
                songAlias.textContent = song.别名?.join(', ') || '无';
                
                // 更新等级显示
                const levels = document.querySelectorAll('.level');
                levels.forEach((level, index) => {
                    level.textContent = `${['Basic', 'Advanced', 'Expert', 'Master'][index]}: ${info.等级[index]}`;
                });
                
                counter++;
                acceleration++;
                
                // 逐渐减速
                if (counter > 20) {
                    speed = 50 + acceleration * 15;
                }
                
                if (counter >= maxSwitches || speed > 500) {
                    clearInterval(switchInterval);
                    
                    // 最终确定一首随机歌曲
                    const finalIndex = Math.floor(Math.random() * filteredSongs.length);
                    const finalSong = filteredSongs[finalIndex];
                    const finalInfo = finalSong.基础信息;
                    
                    coverImage.src = getCoverUrl(finalSong);
                    songTitle.textContent = finalInfo.title;
                    songArtist.textContent = finalInfo.artist;
                    songBpm.textContent = finalInfo.bpm;
                    songVersion.textContent = finalInfo.版本;
                    songDiff.textContent = finalInfo.定数[3];
                    songId.textContent = finalInfo.MusicID;
                    songType.textContent = finalInfo.type;
                    songAlias.textContent = finalSong.别名?.join(', ') || '无';
                    
                    // 更新等级显示
                    levels.forEach((level, index) => {
                        level.textContent = `${['Basic', 'Advanced', 'Expert', 'Master'][index]}: ${finalInfo.等级[index]}`;
                    });
                    
                    // 启用按钮
                    drawButton.disabled = false;
                }
            };
            
            // 初始快速切换
            const switchInterval = setInterval(switchSong, speed);
        }

        // 填充搜索结果
        function populateSearchResults(songs) {
            const resultsContainer = document.getElementById('search-results');
            resultsContainer.innerHTML = '';
            
            if (songs.length === 0) {
                resultsContainer.innerHTML = '<p style="text-align: center; color: #666; padding: 30px;">没有可显示的歌曲，请先加载数据库</p>';
                return;
            }
            
            songs.forEach(song => {
                const info = song.基础信息;
                const songElement = document.createElement('div');
                songElement.classList.add('song-item');
                songElement.innerHTML = `
                    <img src="${getCoverUrl(song)}" alt="${info.title}" class="song-thumb">
                    <div class="song-meta">
                        <div class="song-name">${info.title}</div>
                        <div class="song-artist-small">${info.artist}</div>
                        <div class="song-levels">
                            ${info.等级.map(lvl => `<span class="level-tag">${lvl}</span>`).join('')}
                        </div>
                    </div>
                `;
                
                songElement.addEventListener('click', () => addToSelected(song));
                resultsContainer.appendChild(songElement);
            });
        }

        // 搜索歌曲
        function searchSongs(query) {
            if (!query.trim()) {
                populateSearchResults(songDatabase);
                return;
            }
            
            const filteredSongs = songDatabase.filter(song => {
                const info = song.基础信息;
                const searchStr = `${info.title} ${info.artist} ${info.MusicID} ${song.别名?.join(' ') || ''}`.toLowerCase();
                return searchStr.includes(query.toLowerCase());
            });
            
            populateSearchResults(filteredSongs);
        }

        // 添加到已选列表
        function addToSelected(song) {
            const selectedList = document.getElementById('selected-songs');
            const info = song.基础信息;
            
            // 检查是否已存在
            const existing = document.querySelector(`[data-id="${info.MusicID}"]`);
            if (existing) return;
            
            const songElement = document.createElement('div');
            songElement.classList.add('selected-item');
            songElement.dataset.id = info.MusicID;
            songElement.innerHTML = `
                <img src="${getCoverUrl(song)}" alt="${info.title}" class="selected-thumb">
                <div class="selected-info">
                    <div class="song-name">${info.title}</div>
                    <div class="song-artist-small">${info.artist}</div>
                </div>
                <button class="remove-btn">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            // 添加移除事件
            songElement.querySelector('.remove-btn').addEventListener('click', () => {
                songElement.remove();
                updateSelectedCount();
            });
            
            selectedList.appendChild(songElement);
            updateSelectedCount();
        }

        // 更新已选歌曲计数
        function updateSelectedCount() {
            const count = document.querySelectorAll('.selected-item').length;
            document.getElementById('selected-count').textContent = `(${count})`;
        }

        // 保存歌单
        function savePlaylist() {
            const selectedItems = document.querySelectorAll('.selected-item');
            if (selectedItems.length === 0) {
                alert('请至少选择一首歌曲！');
                return;
            }
            
            const musicIds = Array.from(selectedItems).map(item => item.dataset.id);
            const content = musicIds.join(',');
            
            // 创建下载
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = 'maimai_playlist.txt';
            document.body.appendChild(a);
            a.click();
            
            // 清理
            setTimeout(() => {
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }, 100);
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
